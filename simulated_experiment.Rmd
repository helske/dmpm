---
title: "Simulated example"
author: "Jouni Helske and Santtu Tikka"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
eval <- FALSE # Whether or not to rerun the models and simulations
```

Load some packages and create the data:

```{r}
library(dynamite)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
```

fix number of individuals and number of time points:

```{r}
# number of individuals
m <- 500
# number of time points before intervention
n1 <- 80
# number of time points after the first intervention
# (inluding the first time point of intervention)
n2 <- 20
# total number of time points
n <- n1 + n2
```

Function for simulating the data:

```{r}
simulate_data <- function(scenario) {

  sigma_y <- sigma_x <- 0.4
  beta_yx <- 0.4
  beta_yy <- 0.6
  beta_xx <- 0.9
  beta_xy <- -0.1
  beta_xz <- 0.4
  beta_yz <- 1
  if (scenario == 1) {
    z <- rep(c(0, 1, 0), times = c(n1, 1, n2 - 1))
  } else {
    z <- rep(0:1, times = c(n1, n2))
  }
  # with intervention
  x <- y <- matrix(0, m, n)
  # no intervention
  x_ <- y_ <- matrix(0, m, n)
  # means
  mean_y <- mean_y_ <- matrix(0, m, n)
  x[, 1] <- x_[, 1] <- rnorm(m)
  y[, 1] <- y_[, 1] <- rnorm(m)
  for(i in 2:n1) {
    mean_y[, i]  <- beta_yy * y[, i - 1] + beta_yx * x[, i - 1]
    mean_y_[, i] <- mean_y[, i]
    e_x <- rnorm(m, 0, sigma_x)
    e_y <- rnorm(m, 0, sigma_y)
    x[, i] <- beta_xy * y[, i - 1] + beta_xx * x[, i - 1] + e_x
    y[, i] <- mean_y[, i] + e_y
    x_[, i] <- x[, i]
    y_[, i] <- y[, i]
  }
  for(i in (n1 + 1):n) {
    mean_y[, i]  <- beta_yz * z[i] + beta_yy * y[, i - 1] + beta_yx * x[, i - 1]
    mean_y_[, i] <- beta_yy * y_[, i - 1] + beta_yx * x_[, i - 1]
    e_x <- rnorm(m, 0, sigma_x)
    e_y <- rnorm(m, 0, sigma_y)
    x[, i] <- beta_xz * z[i] + beta_xy * y[, i - 1] + beta_xx * x[, i - 1] + e_x
    y[, i] <- mean_y[, i] + e_y
    x_[, i] <- beta_xy * y_[, i - 1] + beta_xx * x_[, i - 1] + e_x
    y_[, i] <- mean_y_[, i] + e_y
  }
  data.frame(
    y = c(t(y)),
    x = c(t(x)),
    y_ = c(t(y_)),
    x_ = c(t(x_)),
    mean_y = c(t(mean_y)),
    mean_y_ = c(t(mean_y_)),
    z = z,
    time = 1:n,
    id = rep(factor(1:m), each = n))
}
```

## Scenario 1

Create data:
```{r}
set.seed(808)
# Data for the atomic case
d_1 <- simulate_data(scenario = 1)
true_effect_1 <- d_1 |>
  filter(time > n1) |>
  group_by(time) |>
  summarise(mean = mean(mean_y - mean_y_))
```

Estimate the model with dynamite:
```{r, eval = eval}
# Estimate the model
fit_1 <- dynamite(
  obs(y ~ z, family = "gaussian") + obs(x ~ z, family = "gaussian") + lags(),
  data = d_1,
  time = "time",
  group = "id",
  chains = 4, cores = 4, refresh = 0)
saveRDS(fit_1, file = "fit_simulated_scenario1.rds")
```

```{r, echo = FALSE}
fit_1 <- readRDS("fit_simulated_scenario1.rds")
```

Check MCMC diagnostics:
```{r}
mcmc_diagnostics(fit_1)
```

Parameter estimates: 

```{r}
as_draws(fit_1) |> 
  posterior::summarise_draws(
    "mean", 
    "sd",
    ~quantile(.x, probs = c(0.025, 0.975)),
     "rhat", "ess_bulk", "ess_tail")
```

Estimate the causal effects:
```{r, eval = eval}
newdata <- d_1 |>
  mutate(
    y = ifelse(time > n1, NA, y),
    x = ifelse(time > n1, NA, x)
  ) |> 
  filter(time >= n1)

intervention_correct <- predict(
  fit_1, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

newdata <- d_1 |>
  mutate(
    y = ifelse(time > n1, NA, y),
    x = ifelse(time > n1, NA, x),
    z = 0
  ) |> 
  filter(time >= n1)

no_intervention_correct <- predict(
  fit_1, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

newdata <- d_1 |>
  mutate(
    y = ifelse(time > n1, NA, y)
  ) |> 
  filter(time >= n1)

intervention_incorrect <- predict(
  fit_1, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

newdata <- d_1 |>
  mutate(
    y = ifelse(time > n1, NA, y),
    z = 0
  ) |> 
  filter(time >= n1)

no_intervention_incorrect <- predict(
  fit_1, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

results_1 <- bind_rows(
  correct = bind_rows(
    yes = intervention_correct,
    no = no_intervention_correct,
    .id = "intervention"
  ),
  incorrect = bind_rows(
    yes = intervention_incorrect,
    no = no_intervention_incorrect,
    .id = "intervention"
  ),
  .id = "Method"
) |>
  filter(time > n1) |>
  group_by(Method, time, .draw) |>
  summarise(
    difference = mean_y[intervention == "yes"] - mean_y[intervention == "no"]
  ) |>
  group_by(Method, time) |>
  summarise(
    mean = mean(difference),
    q2.5 = quantile(difference, 0.025),
    q97.5 = quantile(difference, 0.975),
    q10 = quantile(difference, 0.1),
    q90 = quantile(difference, 0.9),
  )
saveRDS(results_1, file = "results_scenario1.rds")
```

## Scenario 2

Create data:
```{r}
set.seed(808)
# Data for the recurring case
d_2 <- simulate_data(scenario = 2)
true_effect_2 <- d_2 |>
  filter(time > n1) |>
  group_by(time) |>
  summarise(mean = mean(mean_y - mean_y_))
```

Estimate the model with dynamite:
```{r, eval = eval}
# Estimate the model
fit_2 <- dynamite(
  obs(y ~ z, family = "gaussian") + obs(x ~ z, family = "gaussian") + lags(),
  data = d_2,
  time = "time",
  group = "id",
  chains = 4, cores = 4, refresh = 0)
saveRDS(fit_2, file = "fit_simulated_scenario2.rds")
```

```{r, echo = FALSE}
fit_2 <- readRDS("fit_simulated_scenario2.rds")
```

Check MCMC diagnostics:
```{r}
mcmc_diagnostics(fit_2)
```

Parameter estimates: 

```{r}
as_draws(fit_2) |> 
  posterior::summarise_draws(
    "mean", 
    "sd",
    ~quantile(.x, probs = c(0.025, 0.975)),
     "rhat", "ess_bulk", "ess_tail")
```

Estimate the causal effects:

```{r, eval = eval}
newdata <- d_2 |>
  mutate(
    y = ifelse(time > n1, NA, y),
    x = ifelse(time > n1, NA, x)
  ) |> 
  filter(time >= n1)

intervention_correct <- predict(
  fit_2, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

newdata <- d_2 |>
  mutate(
    y = ifelse(time > n1, NA, y),
    x = ifelse(time > n1, NA, x),
    z = 0
  )  |> 
  filter(time >= n1)

no_intervention_correct <- predict(
  fit_2, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

newdata <- d_2 |>
  mutate(
    y = ifelse(time > n1, NA, y)
  ) |> 
  filter(time >= n1)

intervention_incorrect <- predict(
  fit_2, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

newdata <- d_2 |>
  mutate(
    y = ifelse(time > n1, NA, y),
    z = 0
  ) |> 
  filter(time >= n1)

no_intervention_incorrect <- predict(
  fit_2, newdata = newdata, type = "mean", funs = list(y = list(mean = mean))
)$simulated

results_2 <- bind_rows(
  correct = bind_rows(
    yes = intervention_correct,
    no = no_intervention_correct,
    .id = "intervention"
  ),
  incorrect = bind_rows(
    yes = intervention_incorrect,
    no = no_intervention_incorrect,
    .id = "intervention"
  ),
  .id = "Method"
) |>
  filter(time > n1) |>
  group_by(Method, time, .draw) |>
  summarise(
    difference = mean_y[intervention == "yes"] - mean_y[intervention == "no"]
  ) |>
  group_by(Method, time) |>
  summarise(
    mean = mean(difference),
    q2.5 = quantile(difference, 0.025),
    q97.5 = quantile(difference, 0.975),
    q10 = quantile(difference, 0.1),
    q90 = quantile(difference, 0.9),
  )
saveRDS(results_2, file = "results_scenario2.rds")
```

## Figures for the paper

```{r}
results_1 <- readRDS("results_scenario1.rds")
results_2 <- readRDS("results_scenario2.rds")
p <- bind_rows(
  `Scenario 1` = results_1,
  `Scenario 2` = results_2,
  .id = "Intervention"
) |>
  ggplot(aes(time, mean)) +
  geom_ribbon(aes(ymin = q2.5, ymax = q97.5, fill = Method)) +
  geom_line(aes(linetype = Method)) +
  scale_fill_grey(
    start = 0.75, 
    end = 0.45, 
    labels = c("Correct", "Incorrect")
  ) +
  scale_linetype_manual(
    values = c("solid", "longdash"),
    labels = c("Correct", "Incorrect")
  ) +
  ylab("Average causal effect") + 
  xlab("Time") + xlim(c(80, 100)) +
  theme_bw(base_size = 14) + 
  theme(
    legend.position = "bottom", 
    panel.grid.minor.x = element_blank(),
    legend.key.width = unit(1.75, "cm")
  ) + 
  facet_wrap(~ Intervention, scales = "free")
p
ggsave(p, file = "../ex1_results.png", width = 7, height = 4)
```

Same figure where the true effects are shown in red:

```{r}
p <- bind_rows(
  `Scenario 1` = results_1,
  `Scenario 2` = results_2,
  .id = "Intervention"
) |>
  ggplot(aes(time, mean)) +
  geom_ribbon(aes(ymin = q2.5, ymax = q97.5, fill = Method)) +
  geom_line(aes(linetype = Method)) +
  scale_fill_grey(
    start = 0.75, 
    end = 0.45, 
    labels = c("Correct", "Incorrect")
  ) +
  geom_line(data = cbind(Intervention = "Scenario 1", true_effect_1), colour = "tomato") +
    geom_line(data = cbind(Intervention = "Scenario 2", true_effect_2), colour = "tomato") +
  scale_linetype_manual(
    values = c("solid", "longdash"),
    labels = c("Correct", "Incorrect")
  ) +
  ylab("Average causal effect") + 
  xlab("Time") + xlim(c(n1, n)) +
  theme_bw(base_size = 14) + 
  theme(
    legend.position = "bottom", 
    panel.grid.minor.x = element_blank(),
    legend.key.width = unit(1.75, "cm")
  ) + 
  facet_wrap(~ Intervention, scales = "free")
p
ggsave(p, file = "../ex1_results_with_truth.png", width = 7, height = 4)
```
