---
title: "Employment example"
author: "Jouni Helske and Santtu Tikka"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
eval <- FALSE # whether to estimate the model and causal effects again
```

Load some packages and create the data:

```{r}
library(dplyr)
library(march)
library(dynamite)
library(ggplot2)
library(RColorBrewer)
N <- Employment.2@N
#T <- Employment.2@T[1]
d <- data.frame(
  employment = factor(c(Employment.2@yRaw), labels = c("Full-time", "Other")),
  gender = factor(Employment.2@cov[,,1], labels = c("Woman", "Man")),
  id = 1:N, age = rep(seq(20, 44, by = 2), each = N)
) |>
  mutate(fulltime = as.integer(employment == "Full-time"))
```

Define the model in dynamite:
```{r, eval = eval}
set.seed(1)
model_formula <- 
  obs(
    fulltime ~ -1 + gender:lag(ever) + varying(~ -1 + gender + gender:lag(fulltime)),
    family = "bernoulli"
  ) +
  aux(numeric(ever) ~ fulltime == 1 | lag(ever) == 1 | init(0)) +
  splines(df = 6, noncentered = TRUE)
priors <- get_priors(model_formula, data = d, group = "id", time = "age")
priors$prior[priors$type == "tau"] <- "normal(0, 1)"
fit <- dynamite(
  model_formula, data = d, group = "id", time = "age", priors = priors,
  chains = 4, cores = 4, iter = 5000, refresh = 0,
  save_warmup = FALSE
)
saveRDS(fit, file = "fit_employment.rds")
```

Test different values of $D$:
```{r, eval = eval}
set.seed(1)
model_formula <- 
  obs(
    fulltime ~ -1 + gender:lag(ever) + varying(~ -1 + gender + gender:lag(fulltime)),
    family = "bernoulli"
  ) +
  aux(numeric(ever) ~ fulltime == 1 | lag(ever) == 1 | init(0)) +
  splines(df = 4, noncentered = TRUE)
priors <- get_priors(model_formula, data = d, group = "id", time = "age")
priors$prior[priors$type == "tau"] <- "normal(0, 1)"
fit4 <- dynamite(
  model_formula, data = d, group = "id", time = "age", priors = priors,
  chains = 4, cores = 4, iter = 5000, refresh = 0
)
saveRDS(fit4, file = "fit_employment_D4.rds")

set.seed(1)
model_formula <- 
  obs(
    fulltime ~ -1 + gender:lag(ever) + varying(~ -1 + gender + gender:lag(fulltime)),
    family = "bernoulli"
  ) +
  aux(numeric(ever) ~ fulltime == 1 | lag(ever) == 1 | init(0)) +
  splines(df = 8, noncentered = TRUE)
priors <- get_priors(model_formula, data = d, group = "id", time = "age")
priors$prior[priors$type == "tau"] <- "normal(0, 1)"
fit8 <- dynamite(
  model_formula, data = d, group = "id", time = "age", priors = priors,
  chains = 4, cores = 4, iter = 5000, refresh = 0
)
saveRDS(fit8, file = "fit_employment_D8.rds")

set.seed(1)
model_formula <- 
  obs(
    fulltime ~ -1 + gender:lag(ever) + varying(~ -1 + gender + gender:lag(fulltime)),
    family = "bernoulli"
  ) +
  aux(numeric(ever) ~ fulltime == 1 | lag(ever) == 1 | init(0)) +
  splines(df = 15, noncentered = TRUE)
priors <- get_priors(model_formula, data = d, group = "id", time = "age")
priors$prior[priors$type == "tau"] <- "normal(0, 1)"
fit15 <- dynamite(
  model_formula, data = d, group = "id", time = "age", priors = priors,
  chains = 4, cores = 4, iter = 5000, refresh = 0
)
saveRDS(fit15, file = "fit_employment_D15.rds")
```

```{r, echo = FALSE, eval = eval}
l6 <- loo(fit)
l4 <- loo(fit4)
l8 <- loo(fit8)
l15 <- loo(fit15)
save(l4, l6, l8, l15, file = "employment_loo.rds")
```

Compare models with different D values using leave-one-out cross-validation:
```{r, eval = FALSE}
l6 <- loo(fit)
l4 <- loo(fit4)
l8 <- loo(fit8)
l15 <- loo(fit15)
loo::loo_compare(l4, l6, l8, l15)
```
```{r, echo = FALSE}
load(file = "employment_loo.rds")
loo::loo_compare(l4, l6, l8, l15)
fit4 <- readRDS("fit_employment_D4.rds")
fit15 <- readRDS("fit_employment_D15.rds")
```

Deltas for $D=4$:
```{r}
plot_deltas(fit4)
```

Deltas for $D=15$:
```{r}
plot_deltas(fit15)
```

While there is some differences in the smoothness of the time-varying effects, from a predictive pespective the models are essentially indistinguishable. Leave-future-out cross-validation (LFO-CV) is not very informative here as we have only 13 time points and we need to condition on some initial data to make the LFO-CV stable. Nevertheless, it could be performed with `lfo` function, e.g. `lfo(fit, L = 6)` where `L = 6` defines that first 6 time points are used for the initial fit.


```{r, echo = FALSE, eval = FALSE}

# Alternative model where also gender:lag(ever) is time-varying
# This leads to some divergences, would likely need tighter prior on tau:
# For later ages there are no cases with lag(ever) = 0 & employment = 1
# and because there are relatively few time points, the time-varying coefficient
# of gender:lag(ever) tends to cause numerical issues.
set.seed(1)
model_formula_alt <- 
  obs(
    fulltime ~ -1 + varying(~ -1 + gender + gender:lag(ever) + gender:lag(fulltime)),
    family = "bernoulli"
  ) +
  aux(numeric(ever) ~ fulltime == 1 | lag(ever) == 1 | init(0)) +
  splines(df = 6, noncentered = TRUE)

priors <- get_priors(model_formula2, data = d, group = "id", time = "age")
priors$prior[priors$type == "tau"] <- "normal(0, 1)"

fit_alt <- dynamite(
  model_formula2, data = d, group = "id", time = "age", priors = priors,
  chains = 4, cores = 4, iter = 5000, refresh = 0,
  save_warmup = FALSE
)
loo::loo_compare(l6, loo(fit_alt)) # current model is better
```

```{r, echo = FALSE}
fit <- readRDS("fit_employment.rds")
```

Check MCMC diagnostics:
```{r}
mcmc_diagnostics(fit)
```

Time-invariant parameters:

```{r}
as_draws(fit, types = c("beta", "tau")) |> 
  posterior::summarise_draws(
    "mean", 
    "sd",
    ~quantile(.x, probs = c(0.025, 0.975)),
     "rhat", "ess_bulk", "ess_tail")
```

```{r}
coef(fit, probs = c(0.025, 0.975))[, 1:5]
```

Draw figure of time-varying parameters:
```{r, fig.align="center"}
coefs <- coef(fit, type = "delta", probs = c(0.025, 0.1, 0.9, 0.975)) |> 
  filter(time > 20) |> 
    mutate(
      gender = recode(parameter,
      delta_fulltime_genderMan = "Man",
      delta_fulltime_genderWoman = "Woman",
      "delta_fulltime_genderWoman:fulltime_lag1" = "Woman",
      "delta_fulltime_genderMan:fulltime_lag1" = "Man"
    ),
    Coefficient = recode(parameter,
        delta_fulltime_genderMan = "intercept",
        delta_fulltime_genderWoman = "intercept",
        "delta_fulltime_genderWoman:fulltime_lag1" = "lag(employment)",
        "delta_fulltime_genderMan:fulltime_lag1" = "lag(employment)"
    ))
# color version
# p <- ggplot(coefs, aes(time, mean)) +
#     geom_ribbon(aes(ymin = q2.5, ymax = q97.5, fill = Coefficient), alpha = 0.25) +
#     geom_ribbon(aes(ymin = q10, ymax = q90, fill = Coefficient), alpha = 0.25) +
#     geom_line(aes(colour = Coefficient)) + 
#     scale_x_continuous("Age", seq(22, 44, by = 2)) +
#     scale_y_continuous("Value", seq(-6, 8, by = 2)) +
#     theme_bw() +
#     scale_colour_brewer(palette = "Dark2") +
#     scale_fill_brewer(palette = "Dark2") +
#     facet_wrap(~ gender, scales = "fixed") + 
#     theme(legend.position = "bottom", panel.grid.minor.x = element_blank()) 
p <- ggplot(coefs, aes(time, mean)) +
    geom_ribbon(aes(ymin = q2.5, ymax = q97.5, fill = Coefficient), alpha = 0.66) +
    geom_line(aes(linetype = Coefficient)) + 
    scale_x_continuous("Age", seq(22, 44, by = 2)) +
    scale_y_continuous("Value", seq(-6, 8, by = 2)) +
    theme_bw(base_size = 14) +
    scale_linetype_manual(values = c("solid", "longdash")) +
    scale_fill_grey() +
    facet_wrap(~ gender, scales = "fixed") + 
    theme(
      legend.position = "bottom",
      legend.key.width = unit(1.75, "cm"),
      panel.grid.minor.x = element_blank()
    ) 
p
ggsave(p, file = "../deltas_employment.png", width = 7, height = 4)
```

```{r, eval = eval}
# No full time employment at age 30
newdata0 <- d |> filter(age >= 28)
newdata0$fulltime[newdata0$age == 30] <- 0
newdata0$fulltime[newdata0$age > 30] <- NA
# Full time employment at age 30
newdata1 <- d |> filter(age >= 28)
newdata1$fulltime[newdata1$age == 30] <- 1
newdata1$fulltime[newdata1$age > 30] <- NA

pred <- 
  bind_rows(
    no = predict(
      fit, newdata = newdata0,
      funs = list(fulltime = list(mean = mean))
    )$simulated,
    yes = predict(
      fit, newdata = newdata1,
      funs = list(fulltime = list(mean = mean))
    )$simulated,
    .id = "fulltime_30"
  ) |> 
  filter(age > 28) |> 
  reframe(
    difference = mean_fulltime[fulltime_30 == "yes"] - 
      mean_fulltime[fulltime_30 == "no"],
    .by = "age"
  ) |>
  group_by(age) |>
  summarise(
    mean = mean(difference),
    q2.5 = quantile(difference, 0.025),
    q97.5 = quantile(difference, 0.975),
    q10 = quantile(difference, 0.1),
    q90 = quantile(difference, 0.9)
  )
saveRDS(pred, file = "predictions_employment.rds")
```


```{r, fig.align="center"}
pred <- readRDS("predictions_employment.rds")
obs_sumr <- d |> filter(age > 28) |> 
  group_by(id) |>
  mutate(fulltime_30 = ifelse(fulltime[age == 30], "yes", "no")) |>
  group_by(age, fulltime_30) |>
  summarise(mean_fulltime = mean(fulltime)) |>
  group_by(age) |>
  summarise(
    mean = mean(mean_fulltime[fulltime_30 == "yes"] - mean_fulltime[fulltime_30 == "no"]),
    .groups = "keep"
  )
comb <- bind_rows(
  intervention = pred,
  observation = obs_sumr, 
  .id = "Type"
) 
#color version
# p <- comb |>
#   ggplot(aes(age, mean)) +
#   geom_ribbon(data = comb |> filter(Type == "intervention"), 
#     aes(ymin = q2.5, ymax = q97.5, fill = Type), alpha = 0.25, show.legend = FALSE) +
#   geom_ribbon(data = comb |> filter(Type == "intervention"), 
#     aes(ymin = q10, ymax = q90, fill = Type), alpha = 0.25, show.legend = FALSE) +
#   geom_line(aes(linetype = Type)) +
#   scale_x_continuous("Age", seq(30, 44, by = 2)) +
#   scale_y_continuous("Probability", seq(0.2, 1, by = 0.1)) +
#   theme_bw() + 
#   scale_fill_grey(labels = c("Intervention", "Observation"), name = NULL) +
#   scale_shape_discrete(labels = c("Intervention", "Observation"), name = NULL)
#   theme(legend.position = "bottom", 
#     panel.grid.minor.x = element_blank(),
#     panel.grid.minor.y = element_blank()
#   )
p <- comb |>
  ggplot(aes(age, mean)) +
  geom_ribbon(
    data = comb |> filter(Type == "intervention"), 
    aes(ymin = q2.5, ymax = q97.5, fill = Type), 
    alpha = 0.50, 
    show.legend = FALSE
  ) +
  geom_line(aes(linetype = Type)) +
  scale_x_continuous("Age", seq(30, 44, by = 2)) +
  scale_y_continuous("Difference", seq(0.2, 1, by = 0.1)) +
  theme_bw(base_size = 14) + 
  scale_linetype_manual(
    name = NULL, 
    values = c("solid", "longdash"), 
    labels = c("Intervention", "Observation")
  )  +
  scale_fill_grey()  +
  theme(
    legend.position = "bottom", 
    legend.key.width = unit(1.75, "cm"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()
  )
p
ggsave(p, file = "../causaleffect_employment.png", width = 7, height = 4)
```

Repeat the causal effect estimation for $D=15$ for comparative purposes:

```{r, eval = FALSE}
# No full time employment at age 30
newdata0 <- d |> filter(age >= 28)
newdata0$fulltime[newdata0$age == 30] <- 0
newdata0$fulltime[newdata0$age > 30] <- NA
# Full time employment at age 30
newdata1 <- d |> filter(age >= 28)
newdata1$fulltime[newdata1$age == 30] <- 1
newdata1$fulltime[newdata1$age > 30] <- NA

pred <- 
  bind_rows(
    no = predict(
      fit15, newdata = newdata0,
      funs = list(fulltime = list(mean = mean))
    )$simulated,
    yes = predict(
      fit, newdata = newdata1,
      funs = list(fulltime = list(mean = mean))
    )$simulated,
    .id = "fulltime_30"
  ) |> 
  filter(age > 28) |> 
  reframe(
    difference = mean_fulltime[fulltime_30 == "yes"] - 
      mean_fulltime[fulltime_30 == "no"],
    .by = "age"
  ) |>
  group_by(age) |>
  summarise(
    mean = mean(difference),
    q2.5 = quantile(difference, 0.025),
    q97.5 = quantile(difference, 0.975),
    q10 = quantile(difference, 0.1),
    q90 = quantile(difference, 0.9)
  )
saveRDS(pred, file = "predictions_employment_D15.rds")
```


```{r, fig.align="center"}
pred15 <- readRDS("predictions_employment_D15.rds")
p <- bind_rows(
  d6 = pred,
  d15 = pred15, 
  .id = "D"
) |>
  ggplot(aes(age, mean)) +
  geom_ribbon(
    aes(ymin = q2.5, ymax = q97.5, fill = D), 
    alpha = 0.20, 
    show.legend = FALSE
  ) +
  geom_line(aes(linetype = D)) +
  scale_x_continuous("Age", seq(30, 44, by = 2)) +
  scale_y_continuous("Difference", seq(0.2, 1, by = 0.1)) +
  theme_bw(base_size = 14) + 
  scale_linetype_manual(
    name = NULL, 
    values = c("solid", "longdash"), 
    labels = c("D = 15", "D = 6")
  )  +
  theme(
    legend.position = "bottom", 
    legend.key.width = unit(1.75, "cm"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()
  )
p
ggsave(p, file = "../causaleffect_employment_D6_vs_D15.png", width = 7, height = 4)
```